---
- include: ../ovn_vars.yml ovn_vars_hosts=nomad_client
#==============================================================================#
#
# Deprecation warning: This file has been moved to new repository. Do not modify this copy.
#
# Please see: https://stash.trusted.visa.com:7990/projects/OP/repos/ovn_app_infrastructure/browse
#
#==============================================================================#

# clearing.profile is part of profile file set, and the set is generated by profile-build-daily.
# The source origin of the data set is MVS (mainframe). The profile data set is made available via FTP.
# This FTP activitiy and processing the data set is implemented in profile_build_daily job.
# In production systems this job will run once a day, on specific time (GMT configured).
# On success state of the profile_build_daily activity we will find many of (*.profile) profile files in the defined output folder.
# The current output folder is /profile/Indonesia. Since there is an internal conflict the clearing.profile file is delivered
# with a name clearing_profile.json (by Profile_build_daily).
#
# This clearing_profile.json file is copied to nomad clients for further processing in this specific job.
# From the inventory file we pick configured nomad client target machines and copy the clearing_profile.json as
# clearing.profile file for further processing.
#
# Tasks carried out in the below task
# 1. Verify the path to check about the availability of the file
# 2. Copy the clearing_profile.json file to target Nomad client
# 3. Verify the copied file status at destination and rename the input data file as clearing.profile
# 4. Note:- Clearing.profile is a Json data set (input data) to process on distributed cluster of Nomad system.
# Refer to other relevant jobs to understand the overview
#
#
- name: Fail when allow_ovninfra_playbook is not defined
  hosts: localhost
  gather_facts: no
  tasks:
    - debug:
        var: ALLOW_OVNINFRA_PLAYBOOK
    - debug:
        msg: "ALLOW_OVNINFRA_PLAYBOOK variable is required"
      failed_when: "'true' not in ALLOW_OVNINFRA_PLAYBOOK"


- hosts: all
  gather_facts: no
  tasks:
    - debug:
        msg: "This file has been deprecated and moved to ovn_app_infrastructure repository"
      run_once: true
      
- name: deploy clearing profile
  hosts: nomad_client
  vars:
    src_dir: "{{profile_folder|default(omit)}}"
    dst_dir: /opt/profile
    file_name: clearing_profile.json
    final_file_name: clearing.profile
  tasks:
    - debug:
            msg: "source file to copy '{{ src_dir}}/{{file_name}}'"
      run_once: true

    - name: check for source file existence in the path
      local_action: stat path="{{src_dir}}/{{file_name}}"
      register: stat_of_source_file
      run_once: true

    - debug:
        msg: "file status at path '{{src_dir}}/{{file_name}}' is : {{stat_of_source_file.stat.exists}} "
      run_once: true

    - name: ensuring the folder is available at destination machine
      file:
        path: "{{ dst_dir }}"
        state: directory
        mode: 0755

    - name: copy clearing profile  to nomad client
      copy:
        src: "{{src_dir}}/{{file_name}}"
        dest: "{{ dst_dir }}"
        force: yes
        group: root
        owner: root
        mode: "u=rw,g=rw,o=rw"

    - name: check to see if file exists in the folder.
      stat:
        path: "{{dst_dir}}/{{file_name}}"
      register: file_res
      ignore_errors: True

    - debug:
        msg: "file status at path '{{dst_dir}}/{{file_name}}' is : {{file_res.stat.exists}} "

    - name: remove clearing.profile if found
      file: path={{dst_dir}}/{{final_file_name}} state=absent
      when:
        - file_res.stat.exists

    - name: rename clearing_profile.json to clearing.profile
      command: mv "{{dst_dir}}/{{file_name}}" "{{dst_dir}}/{{final_file_name}}"
      when:
        - file_res.stat.exists
